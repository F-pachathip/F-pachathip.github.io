<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>LabCam — วิเคราะห์</title>
  <meta name="description" content="วิเคราะห์สีจากกล้อง เลือก ROI จับคู่สเกล และบันทึกผล (ต้องล็อกอิน)" />
  <link rel="canonical" href="analysis.html" />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link rel="stylesheet" href="style.css" />
  <script defer src="script.js"></script>
</head>
<body data-page="analysis">
  <div class="site-banner">LabCam Web App</div>
  <header class="site-header">
    <div class="brand"><a href="index.html" class="brand-link">LabCam</a></div>
    <button class="hamburger" aria-label="Toggle navigation" aria-controls="site-nav" aria-expanded="false">
      <span></span><span></span><span></span>
    </button>
    <nav>
      <ul class="navlist" id="site-nav">
        <li><a data-i18n="nav_home" href="index.html">หน้าแรก</a></li>
        <li><a data-i18n="nav_analysis" href="analysis.html" class="active">วิเคราะห์</a></li>
        <li><a data-i18n="nav_reports" href="reports.html">รายงาน</a></li>
        <li><a data-i18n="nav_csv" href="csv.html">CSV Vault</a></li>
      </ul>
    </nav>

    <div class="auth">
      <a id="loginLink" class="btn btn-ghost" href="login.html" data-i18n="nav_login">เข้าสู่ระบบ</a>
      <a id="registerLink" class="btn btn-ghost" href="register.html" data-i18n="nav_register">สมัครสมาชิก</a>
      <button id="logoutBtn" class="btn btn-ghost" style="display:none" data-i18n="nav_logout">ออกจากระบบ</button>
    </div>

    <div class="lang">
      <button id="langToggle" class="btn btn-ghost" aria-label="Toggle language">ภาษาไทย</button>
    </div>
  </header>

  <main class="container">
    <h1 data-i18n="analysis_title">วิเคราะห์จากกล้อง</h1>
    <div class="grid-2">
      <section class="card">
        <div class="video-wrap">
          <video id="video" playsinline autoplay muted></video>
          <canvas id="frameCanvas" width="640" height="480"></canvas>
          <canvas id="roiCanvas" width="640" height="480" aria-label="ROI overlay"></canvas>
        </div>
        <div class="controls-row">
          <button id="startCamBtn" class="btn btn-primary" data-i18n="btn_start_cam">เริ่มกล้อง</button>
          <button id="stopCamBtn" class="btn" data-i18n="btn_stop_cam">หยุดกล้อง</button>
          <button id="analyzeBtn" class="btn btn-outline" data-i18n="btn_analyze">วิเคราะห์ ROI</button>
        </div>
        <p class="hint" data-i18n="analysis_hint">ลากเมาส์/นิ้วเพื่อวาดกรอบ ROI บนภาพ</p>
      </section>

      <section class="card">
        <div class="form-grid">
          <label>
            <span data-i18n="label_sample">ชื่อสิ่งตัวอย่าง</span>
            <input id="sampleInput" placeholder="เช่น น้ำตัวอย่าง A" />
          </label>

          <label>
            <span data-i18n="label_reagent">รีเอเจนต์/สเกล</span>
            <select id="reagentSelect"></select>
          </label>

          <div>
            <button id="manageScalesBtn" class="btn btn-ghost" data-i18n="btn_manage_scales">จัดการสเกล</button>
          </div>

          <div class="result-box">
            <div><strong data-i18n="label_color">สีเฉลี่ย</strong>: <span id="avgColorText">-</span> <span id="avgColorSwatch" class="swatch"></span></div>
            <div><strong data-i18n="label_estimate">ค่าโดยประมาณ</strong>: <span id="estimateText">-</span></div>
          </div>

          <div class="actions">
            <button id="saveResultBtn" class="btn btn-primary" disabled data-i18n="btn_save">บันทึกผล</button>
            <a href="reports.html" class="btn" data-i18n="btn_goto_reports">ไปที่รายงาน</a>
          </div>
        </div>

        <details id="scalesPanel">
          <summary data-i18n="scales_summary">สเกลที่ใช้งาน / เพิ่มสเกลใหม่</summary>
          <div class="scales-editor">
            <div class="scales-row">
              <input id="newScaleName" placeholder="ชื่อสเกลใหม่ (เช่น Nitrate v2)" />
              <button id="addScaleBtn" class="btn btn-outline" data-i18n="btn_add_scale">เพิ่มสเกล</button>
            </div>
            <div class="scales-row">
              <input type="color" id="scaleColor" value="#66bd63" />
              <input type="number" id="scaleValue" placeholder="ค่า (ppm)" />
              <button id="addPointBtn" class="btn" data-i18n="btn_add_point">เพิ่มจุด</button>
              <button id="clearPointsBtn" class="btn btn-ghost" data-i18n="btn_clear_points">ล้างจุด</button>
            </div>
            <div class="scales-row">
              <select id="editScaleSelect"></select>
              <button id="saveScaleBtn" class="btn btn-primary" data-i18n="btn_save_scale">บันทึกสเกล</button>
              <button id="deleteScaleBtn" class="btn btn-danger" data-i18n="btn_delete_scale">ลบสเกล</button>
            </div>
            <pre id="scalePreview" class="codebox"></pre>
          </div>
        </details>
      </section>
    </div>
  </main>

  <footer class="site-footer">
    <span>&copy; 2025 LabCam</span>
  </footer>
</body>
</html>