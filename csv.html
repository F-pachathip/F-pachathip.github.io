<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>AI Color & Nitrate Detector - CSV</title>

  <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded" rel="stylesheet"/>

  <!-- Critical fallback -->
  <style id="critical-style">
    *{box-sizing:border-box} html,body{margin:0}
    body{font-family:'Kanit',system-ui,Arial,sans-serif;background:#0b1220;color:#e7eaf1}
    .header{padding:16px 20px;text-align:center;font-weight:700}
    .content{padding:24px}
  </style>
  <!-- main style + fallback path -->
  <link id="site-style" rel="stylesheet" href="./style.css?v=20250901">
  <script>
    (function(){const l=document.getElementById('site-style');const c=document.getElementById('critical-style');
      const p=["./style.css","style.css","css/style.css","/style.css"];let i=0;const kill=()=>{c&&c.remove();};
      l.addEventListener('load',kill);l.addEventListener('error',()=>{if(++i<p.length) l.href=p[i]+"?v="+Date.now();});setTimeout(kill,2000);
    })();
  </script>
</head>
<body>
  <aside class="navbar">
    <div class="brand">
      <div class="brand-mark"><span class="material-symbols-rounded">science</span></div>
      <div class="brand-text">
        <strong>AI Nitrate</strong>
        <small>Detector Suite</small>
      </div>
    </div>

    <button class="hamburger" onclick="toggleMenu()" aria-label="Menu"><span></span><span></span><span></span></button>

    <ul class="navlist">
      <li><a href="index.html"><span class="material-symbols-rounded">home</span> Home</a></li>
      <li><a href="analysis.html"><span class="material-symbols-rounded">colorize</span> Analysis</a></li>
      <li><a href="reports.html"><span class="material-symbols-rounded">analytics</span> Reports</a></li>
      <li><a class="active-link" href="csv.html"><span class="material-symbols-rounded">table_view</span> CSV</a></li>
    </ul>

    <div class="lang">
      <button id="languageToggle" class="btn chip">ภาษาไทย</button>
    </div>
  </aside>

  <header class="header glass">
    <h1 id="headerText">CSV Embed & Viewer</h1>
  </header>

  <main class="content container">
    <section class="card w-full">
      <h2 class="section-title">ฝัง/แสดงไฟล์ CSV</h2>
      <p class="muted">เลือกหนึ่งวิธีด้านล่างเพื่อโหลดข้อมูล: อัปโหลดไฟล์, วางข้อความ CSV, หรือดึงจาก URL</p>

      <!-- Controls -->
      <div class="toolbar">
        <div class="form-row">
          <label class="file">
            <input type="file" id="csvFileInput" accept=".csv,text/csv">
            <span class="btn btn-outline"><span class="material-symbols-rounded">upload</span> อัปโหลด CSV</span>
          </label>
          <button id="loadSampleBtn" class="btn btn-ghost" title="ลองตัวอย่าง (ถ้ามีไฟล์อยู่ข้างๆ)">
            <span class="material-symbols-rounded">dataset</span> โหลดตัวอย่าง (salesdata_missing4.csv)
          </button>
        </div>

        <div class="form-row">
          <label for="csvUrl">CSV URL</label>
          <input id="csvUrl" placeholder="https://example.com/data.csv">
          <button id="loadUrlBtn" class="btn btn-outline"><span class="material-symbols-rounded">download</span> โหลดจาก URL</button>
        </div>

        <div class="form-row" style="width:100%">
          <label for="csvText">วางข้อความ CSV</label>
          <textarea id="csvText" rows="6" style="width:100%" placeholder='เช่น
header1,header2
a,1
b,2'></textarea>
          <button id="loadTextBtn" class="btn btn-primary"><span class="material-symbols-rounded">play_circle</span> แสดงตาราง</button>
        </div>
      </div>

      <!-- Options -->
      <div class="card soft">
        <h3 class="section-subtitle">ตัวเลือกการแสดงผล</h3>
        <div class="form-row">
          <label for="delimiter">ตัวคั่น</label>
          <select id="delimiter">
            <option value="auto">Auto</option>
            <option value=",">Comma (,)</option>
            <option value=";">Semicolon (;)</option>
            <option value="tab">Tab</option>
            <option value="|">Pipe (|)</option>
          </select>

          <label class="radio"><input type="checkbox" id="hasHeader" checked> แถวแรกเป็นหัวตาราง</label>

          <label for="pageSize">แถวต่อหน้า</label>
          <select id="pageSize">
            <option>25</option><option>50</option><option selected>100</option><option>200</option>
          </select>

          <label for="searchBox">ค้นหา</label>
          <input id="searchBox" placeholder="พิมพ์เพื่อกรองแถว">
          <button id="downloadBtn" class="btn btn-outline"><span class="material-symbols-rounded">save</span> ดาวน์โหลดเป็น CSV</button>
        </div>
      </div>

      <!-- Summary -->
      <p class="muted" id="summary" style="margin:10px 0 6px 0;">ยังไม่ได้โหลดข้อมูล</p>

      <!-- Table -->
      <div class="chart-wrap" style="overflow:auto;">
        <table id="csvTable">
          <thead></thead>
          <tbody></tbody>
        </table>
      </div>

      <!-- Pagination -->
      <div class="form-row" style="justify-content:flex-end; margin-top:10px">
        <button id="prevPage" class="btn btn-ghost"><span class="material-symbols-rounded">chevron_left</span> ก่อนหน้า</button>
        <span class="badge" id="pageInfo">0 / 0</span>
        <button id="nextPage" class="btn btn-ghost">ถัดไป <span class="material-symbols-rounded">chevron_right</span></button>
      </div>
    </section>
  </main>

  <footer class="footer">
    &copy; <span id="currentYear"></span> AI Color & Nitrate Detector. All Rights Reserved.
  </footer>

  <!-- ใช้สคริปต์หลักของไซต์ -->
  <script src="script.js"></script>

  <!-- สคริปต์เฉพาะของหน้า CSV -->
  <script>
  (function(){
    const $ = (s)=>document.querySelector(s);
    const csvTable = $('#csvTable');
    const thead = csvTable.querySelector('thead');
    const tbody = csvTable.querySelector('tbody');
    const summary = $('#summary');
    const searchBox = $('#searchBox');
    const hasHeader = $('#hasHeader');
    const delimiterSel = $('#delimiter');
    const pageSizeSel = $('#pageSize');
    const pageInfo = $('#pageInfo');
    const prevBtn = $('#prevPage');
    const nextBtn = $('#nextPage');

    let rawRows = [];      // array of arrays
    let headers = [];      // header labels
    let filteredIdx = [];  // indices after search
    let page = 1;

    function autoDelimiter(text){
      if (delimiterSel.value !== 'auto') return delimiterSel.value==='tab'?'\\t':delimiterSel.value;
      const candidates = [',',';','\\t','|'];
      let best = ',', bestScore = -1;
      for (const d of candidates){
        const lines = text.split(/\\r?\\n/).slice(0, 30).filter(Boolean);
        const counts = lines.map(l => splitCSVLine(l,d).length);
        const mean = counts.reduce((a,b)=>a+b,0)/Math.max(counts.length,1);
        const varc = counts.reduce((a,b)=>a+(b-mean)*(b-mean),0)/Math.max(counts.length,1);
        const score = mean - varc*0.1;
        if (score>bestScore){bestScore=score; best=d;}
      }
      return best;
    }

    function splitCSVLine(line, delim){
      // CSV-safe splitter (quotes + escaped quotes)
      const d = delim==='\\t'?'\\t':delim;
      const out=[]; let cur=''; let inQ=false;
      for (let i=0;i<line.length;i++){
        const ch=line[i], next=line[i+1];
        if (ch==='\"'){
          if (inQ && next==='\"'){ cur+='\"'; i++; }
          else { inQ = !inQ; }
        } else if (!inQ && ch===d){ out.push(cur); cur=''; }
        else { cur+=ch; }
      }
      out.push(cur);
      return out;
    }

    function parseCSV(text){
      const delim = autoDelimiter(text);
      const lines = text.replace(/\\r/g,'').split('\\n').filter(l=>l.length>0);
      const rows = lines.map(l => splitCSVLine(l, delim).map(v=>v.trim()));
      return {rows, delim};
    }

    function render(){
      const ps = parseInt(pageSizeSel.value,10);
      const total = filteredIdx.length;
      const totalPages = Math.max(1, Math.ceil(total/ps));
      if (page>totalPages) page = totalPages;

      // header
      thead.innerHTML='';
      if (headers.length){
        const tr = document.createElement('tr');
        headers.forEach(h=>{
          const th=document.createElement('th');
          th.textContent=h;
          tr.appendChild(th);
        });
        thead.appendChild(tr);
      }

      // body
      tbody.innerHTML='';
      const start = (page-1)*ps, end = Math.min(start+ps, total);
      for (let i=start; i<end; i++){
        const r = rawRows[filteredIdx[i]];
        const tr = document.createElement('tr');
        r.forEach(c=>{
          const td=document.createElement('td');
          td.textContent=c;
          tr.appendChild(td);
        });
        tbody.appendChild(tr);
      }

      pageInfo.textContent = total? (page+' / '+totalPages) : '0 / 0';
      summary.textContent = total
        ? \`แสดงแถวที่ \${start+1}-\${end} จากทั้งหมด \${total} แถว | คอลัมน์ \${headers.length}\`
        : 'ไม่มีข้อมูลสำหรับเงื่อนไขนี้';
    }

    function applySearch(){
      const q = (searchBox.value||'').toLowerCase();
      if (!q){ filteredIdx = rawRows.map((_,i)=>i); return; }
      filteredIdx = [];
      for (let i=0;i<rawRows.length;i++){
        const r = rawRows[i];
        if (r.some(v => (v||'').toLowerCase().includes(q))) filteredIdx.push(i);
      }
    }

    function setData(allRows){
      headers = [];
      rawRows = [];
      if (allRows.length===0){ filteredIdx=[]; render(); return; }

      if (hasHeader.checked){
        headers = allRows[0];
        rawRows = allRows.slice(1);
      }else{
        const width = Math.max(...allRows.map(r=>r.length));
        headers = Array.from({length:width}, (_,i)=>'col'+(i+1));
        rawRows = allRows;
      }
      applySearch();
      page = 1;
      render();
    }

    // event wiring
    searchBox.addEventListener('input', ()=>{ applySearch(); page=1; render(); });
    pageSizeSel.addEventListener('change', ()=>{ page=1; render(); });
    hasHeader.addEventListener('change', ()=>{ // re-derive headers/content
      // recompute using current raw + headers from source (we need original allRows)
      if (window.__lastAllRows){ setData(window.__lastAllRows); }
    });
    prevBtn.addEventListener('click', ()=>{ if (page>1){ page--; render(); } });
    nextBtn.addEventListener('click', ()=>{ const ps=parseInt(pageSizeSel.value,10); const total=filteredIdx.length; const tp=Math.max(1,Math.ceil(total/ps)); if (page<tp){ page++; render(); } });

    // loaders
    $('#csvFileInput').addEventListener('change', async (e)=>{
      const f = e.target.files?.[0];
      if (!f) return;
      const text = await f.text();
      const {rows} = parseCSV(text);
      window.__lastAllRows = rows;
      setData(rows);
    });

    $('#loadTextBtn').addEventListener('click', ()=>{
      const text = $('#csvText').value||'';
      if (!text.trim()) return;
      const {rows} = parseCSV(text);
      window.__lastAllRows = rows;
      setData(rows);
    });

    $('#loadUrlBtn').addEventListener('click', async ()=>{
      const url = $('#csvUrl').value.trim();
      if (!url) return;
      try{
        const res = await fetch(url);
        const text = await res.text();
        const {rows} = parseCSV(text);
        window.__lastAllRows = rows;
        setData(rows);
      }catch(err){
        alert('ไม่สามารถโหลด CSV จาก URL นี้ได้ (อาจติด CORS)'); 
      }
    });

    $('#loadSampleBtn').addEventListener('click', async ()=>{
      try{
        const res = await fetch('salesdata_missing4.csv');
        if (!res.ok) throw new Error();
        const text = await res.text();
        const {rows} = parseCSV(text);
        window.__lastAllRows = rows;
        setData(rows);
      }catch(err){
        alert('ไม่พบไฟล์ salesdata_missing4.csv อยู่ข้างหน้าเว็บ หรือโหลดไม่ได้');
      }
    });

  })();
  </script>
</body>
</html>
